# OpenGL初探

##图形API简介

`OpenGL（Open Graphics Library）`：是一个跨编程语言、跨平台的编程图形程序接口，它将计算机的资源抽象为一个个 OpenGL 的对象，对这些资源的操作抽象为一个个 OpenGL 指令。

`OpenGL ES （OpenGL for Embedded System）`：是 OpenGL 三维图形 API 的子集，针对手机、PDA 和游戏主机等嵌入式设备而设计，去除了许多不必要和性能低的 API 接口。

`DirectX`：是由很多 API 组成的，DirectX 并不是一个单纯的图形 API 最重要的是 DirectX 是属于 Windows 上一个多媒体处理框架，并不支持 Windows 以外的平台，所以不是跨平台框架。按照性质分类，可以分为四大部分：显示部分、声音部分、输入部分和网络部分。

`Metal`（2014年引入）：Apple 为游戏开发者推出了新的平台技术，该技术能够为 3D 图像提高 10 倍的渲染性能。Metail 是 Apple 为了解决 3D 渲染而推出的框架。



## 图形API目的 解决什么问题

实现图形的底层渲染

~ 比如在游戏开发中，对游戏场景/游戏人物的渲染

~ 比如音视频开发中，对视频解码后的数据渲染

~ 比如在地图引擎，对地图上的数据渲染

~ 比如在动画中，实现动画的绘制

~ 比如在视频处理中，对视频加上滤镜效果



#### OpenGL / OpenGL ES / Metal 在任何项目中解决问题的本质

就是利用 GPU 芯片来高效渲染图形图像。

图形 API 是 iOS 开发者唯一接近 GPU 的方式。



## OpenGL 专业名词解析

#### OpenGL 上下文 【context】

应用程序在调用任何 OpenGL 的指令前，都需要先创建一个 OpenGL 的上下文。这个上下文是一个非常庞大的状态机，保存了 OpenGL 中的各种状态，这也是 OpenGL 指令执行的基础。

由于 OpenGL 上下文是一个巨大的状态机，切换上下文往往会产生较大的开销，但是不同的绘制模块，可能需要使用完全独立的状态管理。因此，可以在应用程序中分别创建多个不同的上下文，在不同的线程中使用不同的上下文，上下文之间共享纹理、缓冲区等资源。这样的方案，会比反复切换上下文，或者大量修改渲染状态，更加合理高效。



#### OpenGL 状态机

状态机描述了一个对象在其生命周期内所经历的各种状态，状态间的转变，发生转变的动因，条件及转变中所执行的活动。



#### 渲染（Rendering）

将图形/图像数据转换成3D空间图像并显示。



#### 顶点数组（VertexArray）和 顶点缓冲区（VertexBuffer）

顶点数据就是要画图像的骨架，OpenGL 中图像都是由图元组成。在 OpenGL ES 中，有3种图元：点、线、三角形。

顶点是指在绘图时，它的顶点位置数据，而这个数据可以直接存储在数组中或者缓存到 GPU 内存中。



#### 管线

在 OpenGL 下渲染图形，就会经历一个一个节点，而这样的操作可以理解为管线。显卡在处理数据的时候是按照固定的顺序来的。



#### 固定管线/存储着色器

早期的 OpenGL，封装了很多种着色器程序块内置的一段包含了光照、坐标变化、裁剪等诸多功能的固定 shader 程序来完成图形的渲染。

但由于 OpenGL 的使用场景非常丰富，固定管线或存储着色器无法完成每一个业务，这时就将相关部分开放成可编程的了。



#### 着色器程序 Shader

将固定渲染管线架构变为了可编程渲染管线。因此，OpenGL 在实际调用绘制函数之前，还需要指定一个由 shader 编译成的着色器程序。常见的着色器主要有：顶点着色器（VertexShader），片段着色器（FragmentShader）/ 像素着色器（PixelShader）/ 片元着色器，几何着色器（GeometryShader），曲面细分着色器（TessellationShader）。直到OpenGL ES 3.0，依然只支持 顶点着色器 和 片元着色器。

OpenGL 在处理 shader 时，通过编译、链接等步骤，生成着色器程序，着色器程序同时包含了顶点着色器和片元着色器的运算逻辑。在 OpenGL 进行绘制的时候，首先由顶点着色器对传入的顶点数据进行运算。再通过图元装配，将顶点转换为图元。然后进行光栅化，将图元这种矢量图形，转换为栅格化数据。最后，将栅格化数据传入片元着色器中进行运算。片元着色器会对栅格化数据中的每一个像素进行运算，并决定像素的颜色。



#### 顶点着色器 VertexShader

一般用来处理图形每个顶点变换【平移/旋转/投影等】。

顶点着色器是 OpenGL 中用于计算顶点属性的程序。



#### 片元着色器 FragmentShader

一般用来处理图形中每个像素点颜色计算和填充。

片元着色器是 OpenGL 中用于计算片段（像素）颜色的程序。



#### GLSL（OpenGL Shading Language）

OpenGL 着色语言（OpenGL Shading Language）是用来在 OpenGL 中着色编程的语言，是在图形卡的 GPU（Graphic Processor Unit 图形处理单元）上执行的，代替了固定的渲染管线的一部分，使渲染管线中不同层次具有可编程性。GLSL 的着色代码分为2个部分：Vertex Shader 和 Fragment Shader。



#### 光栅化 Rasterization

是把顶点数据转换为片元的过程，将图转换成一个个栅格组成的图像的作用，特点是每个元素对应帧缓存区中的一个像素。

光栅化其实是一种将几何图元变为二维图像的过程。

把物体的数学描述以及与物体相关的颜色信息转换为屏幕上用于对应位置的像素及用于填充像素的颜色，这个过程称为光栅化，这是一个将模拟信号转化为离散信号的过程。



#### 纹理

纹理可以理解为图片。渲染图形时需要在其编码填充图片。



#### 混合（Blending）

在测试阶段后，如果像素依然没有被剔除，那么像素的颜色将会和帧缓冲区中颜色附着上的颜色进行混合，混合的算法可以通过 OpenGL 的函数进行指定。



#### 变换矩阵（Transfromation）

例如图形想发生平移、缩放、旋转变换，就需要使用变换矩阵



#### 投影矩阵（Projection）

用于将3D坐标转换为二维屏幕坐标，实际线条也将在二维坐标下进行绘制



#### 渲染上屏/交换缓冲区（SwapBuffer）

常规的 OpenGL 程序至少有两个缓冲区。显示在屏幕上的称为屏幕缓冲区，没有显示的称为离屏缓冲区。通过屏幕缓冲区和离屏缓冲区交换，实现图像在屏幕上的显示。











OpenGL 下坐标系解析

图片/图形从文件渲染到屏幕过程解析

案例01：固定管线下使用OpenGL 渲染三角形

案例02：固定管线下使用OpenGL 渲染正方形，并能通过键盘移动该图形

案例03：固定管线下使用OpenGL 绘制图形









